name: NVIDIA Stock Check (Email)

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

jobs:
  check:
    runs-on: self-hosted
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify system Python
        run: |
          which python3.11
          python3.11 --version
          python3.11 -m pip --version

      - name: Install dependencies (Playwright)
        run: |
          python3.11 -m pip install --upgrade pip
          python3.11 -m pip install playwright==1.49.0
          python3.11 -m playwright install firefox

      - name: Run checker
        run: |
          python3.11 check_nvidia.py

      - name: Send email if IN STOCK (every run)
        env:
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          MAIL_TO: ${{ secrets.MAIL_TO }}
          MAIL_FROM: ${{ secrets.MAIL_FROM }}
        run: |
          if [ -s "in_stock_urls.txt" ]; then
            export MAIL_SUBJECT="âœ… NVIDIA stock checker: IN STOCK"
            export MAIL_BODY="IN STOCK right now:\n\n$(cat in_stock_urls.txt)\n\nTime: $(date -u) UTC"
            python3.11 send_email.py
          else
            echo "Nothing in stock."
          fi
